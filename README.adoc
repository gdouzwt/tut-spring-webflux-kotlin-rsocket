:toc:
:icons: font
:source-highlighter: prettify
:project_id: tut-spring-webflux-kotlin-rsocket
:tabsize: 2
:image-width: 500
:images: https://raw.githubusercontent.com/spring-guides/tut-spring-webflux-kotlin-rsocket/master/static
:book-root: .

æœ¬æ•™ç¨‹ç»™ä½ æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨Spring Bootå’ŒKotlinå†™ä¸€ä¸ªç®€å•çš„èŠå¤©åº”ç”¨ã€‚ä½ ä¼šå­¦ä¹ åˆ°ä»è¯­æ³•å±‚é¢çœ‹ä½¿ç”¨åšæœåŠ¡ç«¯å¼€å‘çš„è¯­æ³•çš„å¥½å¤„ã€‚

æˆ‘ä»¬å°†ä¼šä»ä¸€ä¸ªå®ç°äº†æœ€å°åŠŸèƒ½çš„åº”ç”¨å¼€å§‹ï¼Œç„¶åé€æ­¥å®Œå–„ã€‚åˆšå¼€å§‹ï¼Œåº”ç”¨ä¼šç”Ÿæˆå’Œæ˜¾ç¤ºå‡æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ç»å…¸çš„é˜»å¡è¯·æ±‚-å“åº”æ¨¡å‹å»è·å–æ•°æ®åˆ°UIä¸Šã€‚
é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬é€šè¿‡æ·»åŠ æŒä¹…åŒ–å±‚å’Œä¸€äº›æ‰©å±•å»å®Œå–„åº”ç”¨ï¼Œå¹¶è¿ç§»åˆ°ä¸€ä¸ªéé˜»å¡çš„é¢å‘æµçš„é£æ ¼æ¥å»å°†æ•°æ®ä»åç«¯æœåŠ¡åˆ°UIã€‚

æœ¬æ•™ç¨‹ç”±5éƒ¨åˆ†ç»„æˆï¼š

* ç¬¬1éƒ¨åˆ† åˆå§‹åŒ–è®¾ç½®ä»¥åŠå·¥ç¨‹ç®€ä»‹
* ç¬¬2éƒ¨åˆ† æ·»åŠ æŒä¹…åŒ–å±‚å¹¶é›†æˆæµ‹è¯•
* ç¬¬3éƒ¨åˆ† å®ç°æ‰©å±•
* ç¬¬4éƒ¨åˆ† é‡æ„ä¸ºä½¿ç”¨Spring WebFluxå’ŒKotlin Coroutines
* ç¬¬5éƒ¨åˆ† ä½¿ç”¨RSocketè¿›è¡Œæµå¼ä¼ è¾“

è¿™ä¸ªæ•™ç¨‹é¢å‘å·²ç»ç†Ÿæ‚‰ Spring MVC/ WebFlux å¹¶æƒ³äº†è§£åœ¨ Spring ä½¿ç”¨ Kotlin çš„Javaå¼€å‘è€…ã€‚


== ç¬¬1éƒ¨åˆ†ï¼šåˆå§‹åŒ–è®¾ç½®åŠå·¥ç¨‹ç®€ä»‹

è¦å¼€å§‹æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å…¶ä¸­ä¸€ä¸ªç‰ˆæœ¬çš„ IntelliJ IDEA - ä»»ä½• 2018.1 ä»¥ä¸Šçš„ç‰ˆæœ¬éƒ½å¯ä»¥ã€‚ ä½ å¯ä»¥ä¸‹è½½æœ€æ–°çš„å…è´¹ç¤¾åŒºç‰ˆã€‚

è¿™ä¸ªå·¥ç¨‹æ˜¯åŸºäº Spring Boot 2.4.0çš„ï¼Œè¿™ä¸ªç‰ˆæœ¬éœ€è¦ Kotlin 1.4.10ã€‚ è¯·ç¡®ä¿ 1.4+ ç‰ˆæœ¬çš„ Kotlin æ’ä»¶ä»¥å®‰è£…ã€‚è¦å‡çº§ Kotlin æ’ä»¶ï¼Œå¯ä»¥å»èœå• `Tools | Kotlin | Configure Kotlin Plugin Updates`

=== ä¸‹è½½å·¥ç¨‹

åœ¨ IntelliJ IDEA é€šè¿‡é€‰æ‹© `File | New | Project from Version Control`å»å…‹éš†ä»£ç ä»“åº“ã€‚

image::{images}/download-from-vcs.png[]

æŒ‡å®šå·¥ç¨‹çš„è·¯å¾„ï¼šhttp://github.com/kotlin-hands-on/kotlin-spring-chat.

image::{images}/download-from-vcs-github.png[]

å½“ä½ å…‹éš†äº†å·¥ç¨‹ï¼ŒIntelliJ IDEAä¼šè‡ªåŠ¨åœ°å¯¼å…¥å¹¶æ‰“å¼€å®ƒã€‚å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å…‹éš†å·¥ç¨‹ã€‚

[source,bash]
$ git clone https://github.com/kotlin-hands-on/kotlin-spring-chat.

=== è§£å†³æ–¹æ¡ˆåˆ†æ”¯

æ³¨æ„åˆ°å·¥ç¨‹åŒ…å«æ•™ç¨‹çš„æ¯ä¸€éƒ¨åˆ†çš„è§£å†³æ–¹æ¡ˆåˆ†æ”¯ã€‚ä½ å¯ä»¥é€šè¿‡åœ¨IDEä¸­è°ƒç”¨Branchesçš„åŠ¨ä½œå»æµè§ˆæ‰€æœ‰çš„åˆ†æ”¯:

image::{images}/intellij-git-branches.png[]

æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œ:

[source,bash]
git branch -a

å¯ä»¥ä½¿ç”¨IntelliJ IDEA `Compare with branch` å‘½ä»¤å»æ¯”è¾ƒä½ çš„è§£å†³æ–¹æ¡ˆä¸ç»™å‡ºçš„ç‰ˆæœ¬ã€‚

image::{images}/intellij-git-compare-with-branch.png[]

ä¾‹å¦‚ï¼Œè¿™é‡Œåˆ—å‡º`initial`åˆ†æ”¯å’Œ`part-2`åˆ†æ”¯ä¹‹é—´çš„å·®å¼‚:

image::{images}/intellij-git-compare-with-branch-diff.png[]

é€šè¿‡ç‚¹å‡»å•ç‹¬çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥çœ‹åˆ°è¡Œçº§åˆ«çš„æ›´æ”¹ã€‚

image::{images}/intellij-git-compare-with-branch-file-diff.png[]

å½“ä½ åœ¨æ­¤æ•™ç¨‹çš„ä»»ä½•é˜¶æ®µé‡åˆ°æ•™ç¨‹æ­¥éª¤ç›¸å…³çš„é—®é¢˜æ—¶è¿™åº”è¯¥ä¼šæœ‰å¸®åŠ©

=== å¯åŠ¨åº”ç”¨

é‚£ä¸ªåº”ç”¨çš„`main`æ–¹æ³•æ˜¯ä½äº `ChatKotlinApplication.kt`æ–‡ä»¶ã€‚ç›´æ¥ç‚¹å‡» main æ–¹æ³•æ—è¾¹çš„ gutter å›¾æ ‡ï¼Œæˆ–è€…æŒ‰ä¸‹ `Alt+Enter`å¿«æ·é”®è°ƒç”¨IntelliJ IDEA çš„å¯åŠ¨èœå•ã€‚

image::{images}/intellij-run-app-from-main.png[]

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ç»ˆç«¯å‘½ä»¤è¡Œè¿è¡Œ `./gradlew bootRun`ã€‚

ä¸€æ—¦ç¨‹åºå¯åŠ¨äº†ï¼Œæ‰“å¼€ä»¥ä¸‹ URL: http://localhost:8080 ä½ ä¼šçœ‹åˆ°ä¸€ä¸ªèŠå¤©é¡µé¢æœ‰å¾ˆå¤šæ¶ˆæ¯

image::{images}/chat.gif[]

åœ¨ä»¥ä¸‹æ­¥éª¤ï¼Œæˆ‘ä¼šæ¼”ç¤ºå¦‚ä½•æ•´åˆæ•°æ®åº“åˆ°æˆ‘ä»¬çš„åº”ç”¨å»å­˜å‚¨æ¶ˆæ¯ã€‚

=== å·¥ç¨‹æ¦‚è§ˆ

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ•´ä¸ªåº”ç”¨çš„æ¦‚è§ˆã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ï¼Œæˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç®€å•çš„èŠå¤©åº”ç”¨ï¼Œå…·æœ‰ä»¥ä¸‹æ¶æ„ï¼š

image::{images}/application-architecture.png[]

æˆ‘ä»¬çš„åº”ç”¨æ˜¯ä¸€ä¸ªæ™®é€šçš„3å±‚webåº”ç”¨ã€‚é¢å‘å®¢æˆ·ç«¯çš„é‚£å±‚æ˜¯ç”± `HtmlController` å’Œ `MessageResource`ç±»å®ç°çš„ã€‚è¿™ä¸ªåº”ç”¨åˆ©ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä½¿ç”¨ _Thymeleaf_ æ¨¡æ¿å¼•æ“ï¼Œå¹¶ä¸”æœåŠ¡ä¸º `HtmlController`ã€‚ æ¶ˆæ¯æ•°æ®çš„APIæ˜¯ç”±`MessageResource`æä¾›ï¼Œ

æœåŠ¡å±‚æ˜¯ç”±`MessageService`è¡¨ç°,è¿™ä¸ªæœ‰ä¸¤ä¸ªä¸åŒçš„å®ç°ï¼š

*   `FakeMessageService` - èµ·åˆçš„å®ç°ï¼Œè¿™ä¼šäº§ç”Ÿéšæœºæ¶ˆæ¯ã€‚
*   `PersistentMessageService` - ç¬¬2ä¸ªå®ç°ï¼Œä½¿ç”¨çš„æ˜¯çœŸå®æ•°æ®å­˜å‚¨ã€‚æˆ‘ä»¬ä¼šåœ¨æœ¬æ•™ç¨‹çš„ç¬¬2éƒ¨åˆ†æ·»åŠ è¿™éƒ¨åˆ†å®ç°

è¿™ä¸ª `PersistentMessageService` è¿æ¥åˆ°æ•°æ®åº“å­˜å‚¨æ¶ˆæ¯ã€‚æˆ‘ä¼šä½¿ç”¨ H2 æ•°æ®åº“å¹¶é€šè¿‡ Spring Data Repository API å»è®¿é—®å®ƒã€‚

åœ¨ä½ ä¸‹è½½äº†å·¥ç¨‹çš„æºç å¹¶åœ¨IDEæ‰“å¼€åï¼Œä½ ä¼šçœ‹åˆ°ä»¥ä¸‹ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬äº†å‰é¢æåˆ°çš„ç±»ã€‚
image::{images}/project-tree.png[]


åœ¨ `main/kotlin` æ–‡ä»¶å¤¹ä¹‹ä¸‹æœ‰å±äºåº”ç”¨ç¨‹åºçš„åŒ…å’Œç±»ã€‚åœ¨é‚£ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œæˆ‘ä»¬å°†ä¼šæ·»åŠ æ›´å¤šçš„ç±»å’Œè®©ç°å­˜çš„ä»£ç æ¼”è¿›æˆä¸€ä¸ªåº”ç”¨ã€‚

åœ¨é‚£ä¸ª `main/resources` æ–‡ä»¶å¤¹ä½ ä¼šå‘ç°å„ç§é™æ€èµ„æºå’Œé…ç½®æ–‡ä»¶ã€‚

é‚£ä¸ª `test/kotlin` æ–‡ä»¶å¤¹åŒ…å«äº†æµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬å°†å¯¹æµ‹è¯•ç”¨ä¾‹çš„æºç æ ¹æ®åº”ç”¨ç¨‹åºçš„ä¸»è¦ä»£ç åšç›¸åº”çš„ä¿®æ”¹ã€‚

ç¨‹åºçš„å…¥å£ç‚¹æ˜¯ `ChatKotlinApplication.kt`æ–‡ä»¶ã€‚è¿™é‡Œæ˜¯`main`æ–¹æ³•æ‰€åœ¨çš„åœ°æ–¹ã€‚

==== HtmlController

`HtmlController`æ˜¯ä¸€ä¸ªè¢«`@Controller`æ³¨è§£çš„ç«¯ç‚¹ï¼Œå®ƒä¼šæš´éœ²ä¸€ä¸ªé€šè¿‡ thymeleaf ç”Ÿæˆçš„ HTML é¡µé¢ã€‚

[source,kotlin]
-----
import com.example.kotlin.chat.service.MessageService
import com.example.kotlin.chat.service.MessageVM
import org.springframework.stereotype.Controller
import org.springframework.ui.Model
import org.springframework.ui.set
import org.springframework.web.bind.annotation.GetMapping

@Controller
class HtmlController(val messageService: MessageService) {
   @GetMapping("/")
   fun index(model: Model): String {
       val messages = messageService.latest()

       model["messages"] = messages
       model["lastMessageId"] = messages.lastOrNull()?.id ?: ""
       return "chat"
   }
}
-----

ğŸ’¡ ä½ å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°Kotlinçš„å…¶ä¸­ä¸€ä¸ªç‰¹æ€§å°±æ˜¯ç±»å‹æ¨å¯¼ã€‚è¿™æ„å‘³ç€ä½ çš„ä»£ç ä¸­çš„ä¸€äº›ç±»å‹ä¿¡æ¯è¢«çœç•¥äº†ï¼Œç”±ç¼–è¯‘å™¨æ¨å¯¼ã€‚

åœ¨æˆ‘ä»¬ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œç¼–è¯‘å™¨é€šè¿‡è§‚å¯Ÿ`messageService.latest()`å‡½æ•°çš„è¿”å›å€¼çŸ¥é“`messages`å˜é‡çš„ç±»å‹æ˜¯`List&lt;MessageVM&gt;`ã€‚

ğŸ’¡ Spring Webç”¨æˆ·å¯èƒ½æ³¨æ„åˆ°åœ¨æœ¬ä¾‹ä¸­é‚£ä¸ª `Model` ç”¨ä½œä¸€ä¸ª `Map` å°½ç®¡å®ƒæ²¡æœ‰æ‰©å±•è¿™ä¸ª APIã€‚
è¿™ä¸ªå› ä¸ºhttps://docs.spring.io/spring-framework/docs/5.0.0.RELEASE/kdoc-api/spring-framework/org.springframework.ui/index.html [å¦ä¸€ä¸ªKotlinæ‰©å±•] è€Œæˆä¸ºå¯èƒ½ï¼Œå®ƒæä¾›äº†å¯¹ `set` æ“ä½œç¬¦çš„é‡è½½ã€‚æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹https://kotlinlang.org/docs/reference/operator-overloading.html[operator overloading] æ–‡æ¡£.

ğŸ’¡ Null safety æ˜¯è¿™è¯­è¨€çš„æœ€é‡è¦ç‰¹æ€§ä¹‹ä¸€ã€‚åœ¨ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåº”ç”¨å…·æœ‰è¿™æ ·çš„ç‰¹æ€§ï¼š`messages.lastOrNull()?.id ?:""."` é¦–å…ˆï¼Œ`?`æ˜¯ safe call æ“ä½œç¬¦ï¼Œè¿™ä¼šæ£€æŸ¥ `lastOrNull()` çš„ç»“æ„æ˜¯å¦ä¸º `null`ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ª `id`ã€‚ å¦‚æœè¡¨è¾¾å¼çš„ç»“æœæ˜¯ `null`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª Elvis æ“ä½œç¬¦å»æä¾›ä¸€ä¸ªé»˜è®¤å€¼ï¼Œè¿™åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ç©ºå­—ç¬¦ä¸²(`""`)


==== MessageResource

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªAPIç«¯ç‚¹æœåŠ¡äºæŸ¥è¯¢è¯·æ±‚ã€‚è¿™ä¸ªåŠŸèƒ½ç‚¹æ˜¯ç”± `MessageResource`ç±»å®ç°çš„ï¼Œå®ƒå°†æœ€æ–°çš„æ¶ˆæ¯ä»¥ JSON æ ¼å¼æš´éœ²ã€‚

å¦‚æœæŒ‡å®š `lastMessageId` æŸ¥è¯¢å‚æ•°ï¼Œè¿™ä¸ªç«¯ç‚¹å°†ä»æŒ‡å®šçš„æ¶ˆæ¯idå¾€åæä¾›æœ€æ–°æ¶ˆæ¯ï¼Œå¦åˆ™å®ƒä¼šæä¾›æ‰€æœ‰å¯ç”¨çš„æ¶ˆæ¯ã€‚

[source,kotlin]
-----
@RestController
@RequestMapping("/api/v1/messages")
class MessageResource(val messageService: MessageService) {

   @GetMapping
   fun latest(@RequestParam(value = "lastMessageId", defaultValue = "") lastMessageId: String): ResponseEntity<List<MessageVM>> {
       val messages = if (lastMessageId.isNotEmpty()) {
           messageService.after(lastMessageId)
       } else {
           messageService.latest()
       }

       return if (messages.isEmpty()) {
           with(ResponseEntity.noContent()) {
               header("lastMessageId", lastMessageId)
               build<List<MessageVM>>()
           }
       } else {
           with(ResponseEntity.ok()) {
               header("lastMessageId", messages.last().id)
               body(messages)
           }
       }
   }

   @PostMapping
   fun post(@RequestBody message: MessageVM) {
       messageService.post(message)
   }
}
-----

ğŸ’¡ åœ¨Kotlinå½“ä¸­ï¼Œ `if` æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œ å¹¶ä¸”å®ƒä¼šè¿”å›ä¸€ä¸ªå€¼ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ª `if` è¡¨è¾¾å¼èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼š
`val messages = if (lastMessageId.isNotEmpty()) {...}`

ğŸ’¡ Kotlinçš„æ ‡å‡†åº“åŒ…å«äº† scope å‡½æ•°ï¼Œå®ƒçš„å”¯ä¸€ç›®çš„å°±æ˜¯å¯ä»¥å»æ‰§è¡Œä¸€ä¸ªå¯¹è±¡ä¸Šä¸‹æ–‡ä¸­çš„ä¸€ä¸ªä»£ç å—ã€‚åœ¨ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `with()` å‡½æ•°æ„å»ºäº†ä¸€ä¸ªå“åº”å¯¹è±¡ã€‚


==== FakeMessageService

`FakeMessageService` æ˜¯ `MessageService` æ¥å£æœ€åˆçš„å®ç°ã€‚ å®ƒä¸ºæˆ‘ä»¬çš„èŠå¤©æä¾›äº†å‡æ•°æ®ã€‚ æˆ‘ä»¬ä½¿ç”¨ Java Faker åº“å»ç”Ÿæˆè¿™äº›å‡æ•°æ®ã€‚ è¿™ä¸ªæœåŠ¡ä½¿ç”¨èå£«æ¯”äºš,å°¤è¾¾ï¼ŒRickå’Œ Mortyçš„åè¨€éšæœºåœ°ç”Ÿæˆæ¶ˆæ¯ã€‚


[source,kotlin]
-----
@Service
class FakeMessageService : MessageService {

    val users: Map<String, UserVM> = mapOf(
        "Shakespeare" to UserVM("Shakespeare", URL("https://blog.12min.com/wp-content/uploads/2018/05/27d-William-Shakespeare.jpg")),
        "RickAndMorty" to UserVM("RickAndMorty", URL("http://thecircular.org/wp-content/uploads/2015/04/rick-and-morty-fb-pic1.jpg")),
        "Yoda" to UserVM("Yoda", URL("https://news.toyark.com/wp-content/uploads/sites/4/2019/03/SH-Figuarts-Yoda-001.jpg"))
    )

    val usersQuotes: Map<String, () -> String> = mapOf(
       "Shakespeare" to { Faker.instance().shakespeare().asYouLikeItQuote() },
       "RickAndMorty" to { Faker.instance().rickAndMorty().quote() },
       "Yoda" to { Faker.instance().yoda().quote() }
    )

    override fun latest(): List<MessageVM> {
        val count = Random.nextInt(1, 15)
        return (0..count).map {
            val user = users.values.random()
            val userQuote = usersQuotes.getValue(user.name).invoke()

            MessageVM(userQuote, user, Instant.now(),
                      Random.nextBytes(10).toString())
        }.toList()
    }

    override fun after(lastMessageId: String): List<MessageVM> {
        return latest()
    }

    override fun post(message: MessageVM) {
        TODO("Not yet implemented")
    }
}
-----


Kotlinçš„å‡½æ•°å¼ç±»å‹ï¼Œæˆ‘ä»¬ç»å¸¸å½“ä½œä¸€ç§ lambdaè¡¨è¾¾å¼ä½¿ç”¨ã€‚ åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`userQuotes` æ˜¯ä¸€ä¸ª map å¯¹è±¡ï¼Œå®ƒçš„keyæ˜¯å­—ç¬¦ä¸²string ç„¶åå€¼æ˜¯ lambda expressionsã€‚ ä¸€ä¸ªç±»å‹ç­¾å `() -> String` è¡¨ç¤ºé‚£ä¸ª lambda è¡¨è¾¾å¼ä¸æ¥å—å‚æ•°ï¼Œå¹¶äº§å‡º `String` ä½œä¸ºç»“æœã€‚ å› æ­¤ï¼Œ `userQuotes` çš„ç±»å‹æ˜¯ç”± `Map&lt;String, () -> String&gt;` æ‰€æŒ‡å®šã€‚


ğŸ’¡ é‚£ä¸ª `mapOf` å‡½æ•°å¯è®©ä½ åˆ›å»ºä¸€ä¸ªâ€œå¯¹â€çš„mapï¼Œè¿™é‡Œçš„ pair's å®šä¹‰æ˜¯ç”± extension æ–¹æ³•æä¾›çš„ï¼š
`&lt;A, B&gt; A.to(that: B): Pair&lt;A, B&gt;`.

ğŸ’¡ é‚£ä¸ª `TODO()` å‡½æ•°æœ‰ä¸¤ä¸ªä½œç”¨:æç¤ºä½œç”¨å’Œæºç è°ƒè¯•ä½œç”¨ï¼Œå› ä¸ºå®ƒæ€»æ˜¯æŠ›å‡º `NotImplementedError` å¼‚å¸¸ã€‚

`FakeMessageService` ç±»çš„ä¸»è¦ä»»åŠ¡æ˜¯ç”Ÿæˆéšæœºæ•°é‡çš„å‡æ•°æ®å‘é€åˆ°èŠå¤©çš„UIã€‚ é‚£ä¸ª `latest()` æ–¹æ³•æ˜¯æ”¾åœ¨è¿™ä¸ªé€»è¾‘å®ç°çš„åœ°æ–¹ã€‚




[source,kotlin]
-----
val count = Random.nextInt(1, 15)
return (0..count).map {
    val user = users.values.random()
    val userQuote = usersQuotes.getValue(user.name).invoke()

    MessageVM(userQuote, user, Instant.now(), Random.nextBytes(10).toString())
  }.toList()
-----

åœ¨ Kotlinï¼Œæƒ³è¦ç”Ÿæˆä¸€ä¸ªèŒƒå›´çš„æ•´æ•°ï¼Œæˆ‘ä»¬åªéœ€è¦å†™ `(0..count)`ã€‚ ç„¶åæˆ‘ä»¬åº”ç”¨ `map()` å‡½æ•°å»è½¬æ¢æ¯ä¸ªæ•°å­—æˆä¸ºæ¶ˆæ¯ã€‚

å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œä»ä»»æ„é›†åˆä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´ çš„æ“ä½œä¹Ÿå¾ˆç®€å•ã€‚ Kotlin ä¸ºé›†åˆæ¡†æ¶æä¾›äº†ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼Œåä¸º `random()`
æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ‰©å±•æ–¹æ³•å»ä»é›†åˆä¸­é€‰æ‹©å¹¶è¿”å›ä¸€ä¸ªç”¨æˆ·ï¼š `users.values.random()`

ä¸€æ—¦ç”¨æˆ·å·²é€‰å®šï¼Œæˆ‘ä»¬éœ€è¦ä» `userQuotes` map é‡Œé¢å»è·å–ç”¨æˆ·çš„å¼•è¯­ã€‚ ä» `userQuotes` æ‰€é€‰ä¸­çš„å€¼å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæˆ‘ä»¬è·å–çœŸå®å¼•è¯­éœ€è¦è°ƒç”¨çš„lambdaè¡¨è¾¾å¼ï¼š `usersQuotes.getValue(user.name).invoke()`

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `MessageVM` ç±»çš„å®ä¾‹ã€‚ è¿™æ˜¯ä¸€ä¸ªç”¨æ¥ä¼ é€æ•°æ®åˆ°å®¢æˆ·ç«¯çš„è§†å›¾æ¨¡å‹ã€‚

[source,kotlin]
-----
data class MessageVM(val content: String, val user: UserVM, val sent: Instant, val id: String? = null)
-----

ğŸ’¡ å¯¹äº data classï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆ `toString`,  `equals` å’Œ `hashCode` å‡½æ•°ï¼Œæœ€å°‘åŒ–ä½ æ‰€éœ€è¦å†™çš„å®ç”¨ä»£ç ã€‚

== ç¬¬ 2 éƒ¨åˆ† æ·»åŠ æŒä¹…åŒ–å’Œé›†æˆæµ‹è¯•

åœ¨è¿™éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€ä¸ªæŒä¹…åŒ–ç‰ˆæœ¬çš„ `MessageService` æ¥å£ï¼Œ ä½¿ç”¨ Spring Data JDBC å’Œ H2 ä½œä¸ºæ•°æ®åº“ã€‚æˆ‘ä»¬ä¼šå¼•å…¥ä»¥ä¸‹ç±»ï¼š

*   `PersistentMessageService` - `MessageService` æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œè¿™ä¼šé€šè¿‡ Spring Data Repository API ä¸çœŸå®çš„æ•°æ®å­˜å‚¨äº¤äº’ã€‚
*   `MessageRepository` â€“ ä¸€ä¸ª `MessageService` ä½¿ç”¨çš„ repository å®ç°ã€‚ 

=== æ·»åŠ æ–°çš„ä¾èµ–

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å¿…è¦çš„ä¾èµ–åˆ°å·¥ç¨‹ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸‹é¢å‡ è¡Œåˆ° build.gradle.kts æ–‡ä»¶çš„ `dependencies` å—è¯­å¥ä¸­ã€‚


[source,kotlin]
-----
implementation("org.springframework.boot:spring-boot-starter-data-jdbc")
runtimeOnly("com.h2database:h2")
-----

âš ï¸ æ³¨æ„ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œ æˆ‘ä»¬ä½¿ç”¨ `spring-data-jdbc` ä½œä¸ºä¸€ç§è½»é‡ä¸”ç›´æ¥çš„æ–¹å¼å»åœ¨ Spring æ¡†æ¶ä¸­ä½¿ç”¨ JDBCã€‚ å¦‚æœä½ æƒ³çœ‹åˆ°ä½¿ç”¨ JPA çš„ä¾‹å­ï¼Œè¯·çœ‹ä»¥ä¸‹åšæ–‡ https://spring.io/guides/tutorials/spring-boot-kotlin/?#_persistence_with_jpa[blog post].

âš ï¸ è¦åˆ·æ–°å·¥ç¨‹çš„ä¾èµ–åˆ—è¡¨ï¼Œ ç‚¹å‡»ç¼–è¾‘å™¨å³ä¸Šè§’çš„å°å¤§è±¡å›¾æ ‡

image::{images}/intellij-gradle-reload.png[]

=== åˆ›å»ºæ•°æ®åº“æ¨¡å¼å’Œé…ç½®

å½“ä¾èµ–è¢«æ·»åŠ å¹¶è§£å†³äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å¯¹æ•°æ®åº“æ¨¡å¼è¿›è¡Œå»ºæ¨¡ã€‚

[source,sql]
-----
CREATE TABLE IF NOT EXISTS messages (
  id                     VARCHAR(60)  DEFAULT RANDOM_UUID() PRIMARY KEY,
  content                VARCHAR      NOT NULL,
  content_type           VARCHAR(128) NOT NULL,
  sent                   TIMESTAMP    NOT NULL,
  username               VARCHAR(60)  NOT NULL,
  user_avatar_image_link VARCHAR(256) NOT NULL
);
-----

âŒ¨ï¸ åœ¨ `src/main/resources` ç›®å½•åˆ›å»ºä¸€ä¸ªåä¸º `sql` çš„æ–‡ä»¶å¤¹ã€‚ ç„¶åå°†ä¸Šé¢çš„ SQL ä»£ç æ”¾åˆ° `src/main/resources/sql/schema.sql` æ–‡ä»¶ä¸­ã€‚

image::{images}/schema-sql-location.png[]

è¿˜æœ‰ï¼Œ ä½ åº”è¯¥ä¿®æ”¹ `application.properties` ä½¿ä¹‹åŒ…å«ä»¥ä¸‹å±æ€§ï¼š

[source,properties]
-----
spring.datasource.schema=classpath:sql/schema.sql
spring.datasource.url=jdbc:h2:file:./build/data/testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=password
spring.datasource.initialization-mode=always
-----

=== æ“çºµæ•°æ®

ä½¿ç”¨ Spring Data, ä¸Šé¢æåˆ°çš„é‚£ä¸ªè¡¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„é¢†åŸŸç±»æ¥è¡¨è¾¾ï¼Œå®ƒåº”è¯¥æ”¾åˆ° `src/main/kotlin/com/example/kotlin/chat/repository/DomainModel.kt ` æ–‡ä»¶ä¸­ï¼š

[source,kotlin]
-----
import org.springframework.data.annotation.Id
import org.springframework.data.relational.core.mapping.Table
import java.time.Instant

@Table("MESSAGES")
data class Message(
    val content: String,
    val contentType: ContentType,
    val sent: Instant,
    val username: String,
    val userAvatarImageLink: String,
    @Id var id: String? = null)

enum class ContentType {
    PLAIN
}
-----

è¿™é‡Œæœ‰äº›éœ€è¦è§£é‡Šçš„ã€‚ åƒ `content`, `sent` å’Œ `id` ç­‰å­—æ®µæ˜¯å¯¹ç…§ `MessageVM` ç±»çš„ã€‚ ç„¶è€Œï¼Œä¸ºäº†å‡å°‘è¡¨çš„æ•°é‡å’Œç®€åŒ–æœ€ç»ˆçš„å…³ç³»ç»“æ„ï¼Œæˆ‘ä»¬å·²ç»æ‰å¹³åŒ–äº† `User` å¯¹è±¡ï¼Œå¹¶ä½¿å®ƒçš„å­—æ®µæ˜¯ `Message`
ç±»çš„ä¸€éƒ¨åˆ†ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ–°çš„å­—æ®µç§°ä¸º `contentType`, è¿™è¡¨ç¤ºæ‰€ä¿å­˜çš„æ¶ˆæ¯çš„å†…å®¹ç±»å‹ã€‚ å› ä¸ºå¤§å¤šç°ä»£çš„èŠå¤©åº”ç”¨æ”¯æŒä¸åŒç±»å‹çš„æ ‡è®°è¯­è¨€ï¼Œæ‰€ä»¥æ”¯æŒä¸åŒçš„æ¶ˆæ¯å†…å®¹ç¼–ç æ˜¯å¾ˆå¸¸è§çš„ã€‚ åˆšå¼€å§‹æˆ‘ä»¬åªæ˜¯æ”¯æŒ `PLAIN` çº¯æ–‡æœ¬ï¼Œä¸è¿‡åé¢æˆ‘ä»¬ä¼šæ‰©å±• `ContentType` ä¹Ÿä»¥æ”¯æŒ `MARKDOWN` ç±»å‹ã€‚
Once we have the table representation as a class, we may introduce convenient access to the data via `Repository`.
ä¸€æ—¦æˆ‘ä»¬å°†è¡¨ä»¥ä¸€ä¸ªç±»è¡¨è¾¾å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `Repository` å¼•å…¥æ–¹ä¾¿çš„è®¿é—®ã€‚

âŒ¨ï¸  å°† `MessageRepository.kt` æ”¾åˆ° `src/main/kotlin/com/example/kotlin/chat/repository` æ–‡ä»¶å¤¹ã€‚

[source,kotlin]
-----
import org.springframework.data.jdbc.repository.query.Query
import org.springframework.data.repository.CrudRepository
import org.springframework.data.repository.query.Param

interface MessageRepository : CrudRepository<Message, String> {

    // language=SQL
    @Query("""
        SELECT * FROM (
            SELECT * FROM MESSAGES
            ORDER BY "SENT" DESC
            LIMIT 10
        ) ORDER BY "SENT"
    """)
    fun findLatest(): List<Message>

    // language=SQL
    @Query("""
        SELECT * FROM (
            SELECT * FROM MESSAGES
            WHERE SENT > (SELECT SENT FROM MESSAGES WHERE ID = :id)
            ORDER BY "SENT" DESC
        ) ORDER BY "SENT"
    """)
    fun findLatest(@Param("id") id: String): List<Message>
}
-----

æˆ‘ä»¬çš„ `MessageRepository` ç»§æ‰¿äº†ä¸€ä¸ªæ™®é€šçš„ `CrudRepository` å¹¶æä¾›äº†ä¸¤ä¸ªä¸åŒçš„å¸¦æœ‰è‡ªå®šä¹‰æŸ¥è¯¢çš„æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºæŸ¥è¯¢æœ€æ–°æ¶ˆæ¯å’Œæ ¹æ®ç‰¹å®š IDè·å–æ¶ˆæ¯ã€‚

ğŸ’¡ ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ° SQL æŸ¥è¯¢é‡‡ç”¨äº†å¯è¯»æ€§å¥½çš„ å¤šè¡Œå­—ç¬¦ä¸² æ ¼å¼ï¼Ÿ Kotlin ä¸ºå­—ç¬¦ä¸²æä¾›äº†ä¸€ç³»åˆ—æœ‰ç”¨çš„é¢å¤–ç‰¹æ€§ã€‚ ä½ å¯ä»¥åœ¨Kotlinæ–‡æ¡£å­¦ä¹ æ›´å¤šå…³äºè¿™äº›é¢å¤–ç‰¹æ€§ã€‚

ä¸‹ä¸€æ­¥æ˜¯å®ç°ä¼šä¸ `MessageRepository` é›†æˆçš„ `MessageService` ç±»

âŒ¨ï¸ å°†é‚£ä¸ª `PersistentMessageService` ç±»æ”¾åˆ° `src/main/kotlin/com/example/kotlin/chat/service` æ–‡ä»¶å¤¹ï¼Œæ›¿æ¢æ‰ `FakeMessageService` å®ç°ã€‚


[source,kotlin]
-----
package com.example.kotlin.chat.service

import com.example.kotlin.chat.repository.ContentType
import com.example.kotlin.chat.repository.Message
import com.example.kotlin.chat.repository.MessageRepository
import org.springframework.context.annotation.Primary
import org.springframework.stereotype.Service
import java.net.URL

@Service
@Primary
class PersistentMessageService(val messageRepository: MessageRepository) : MessageService {

    override fun latest(): List<MessageVM> =
        messageRepository.findLatest()
            .map { with(it) { MessageVM(content, UserVM(username,
                              URL(userAvatarImageLink)), sent, id) } }

    override fun after(lastMessageId: String): List<MessageVM> =
        messageRepository.findLatest(lastMessageId)
            .map { with(it) { MessageVM(content, UserVM(username,
                              URL(userAvatarImageLink)), sent, id) } }

    override fun post(message: MessageVM) {
        messageRepository.save(
            with(message) { Message(content, ContentType.PLAIN, sent,
                         user.name, user.avatarImageLink.toString()) }
        )
    }
}
-----

`PersistentMessageService` æ˜¯ `MessageRepository` çš„ç®€å•å°è£…ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œåªæ˜¯åšä¸€äº›ç®€å•çš„å¯¹è±¡å°è£…ã€‚æ‰€æœ‰çš„ä¸šåŠ¡æŸ¥è¯¢éƒ½å‘ç”Ÿåœ¨ `Repository` å±‚é¢ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿™ç§å®ç°çš„ç®€æ´æ€§æ˜¯ Kotlin è¯­è¨€çš„ä¼˜ç‚¹ï¼Œå®ƒæä¾›äº†åƒ `map` å’Œ `with` ç­‰çš„æ‰©å±•å‡½æ•°ã€‚

å¦‚æœæˆ‘ä»¬ç°åœ¨å¯åŠ¨åº”ç”¨ï¼Œæˆ‘ä»¬å†æ¬¡çœ‹åˆ°ç©ºçš„èŠå¤©é¡µé¢ã€‚ ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬è¾“å…¥ä¸€æ¡æ¶ˆæ¯åˆ°æ–‡æœ¬è¾“å…¥æ¡†å¹¶å‘é€å®ƒï¼Œä¸€ä¼šæˆ‘ä»¬å°†ä¼šçœ‹åˆ°å®ƒå‡ºç°åœ¨å±å¹•ä¸­ã€‚ å¦‚æœæˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ–°çš„æµè§ˆå™¨é¡µé¢ï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨æ¶ˆæ¯å†å²ä¸­çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ã€‚

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€äº›é›†æˆæµ‹è¯•ä»¥ç¡®ä¿æˆ‘ä»¬çš„ä»£ç éšæ—¶é—´æµé€è¿˜èƒ½æ­£å¸¸åœ°è¿è¡Œã€‚

=== æ·»åŠ é›†æˆæµ‹è¯•

è¦å¼€å§‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ `/src/test`ç›®å½•ä¸­çš„ `ChatKotlinApplicationTests`æ–‡ä»¶ï¼Œå¹¶ä¸”æ·»åŠ æˆ‘ä»¬åœ¨æµ‹è¯•ä¸­éœ€è¦ç”¨åˆ°çš„å­—æ®µã€‚


[source,kotlin]
-----
import com.example.kotlin.chat.repository.ContentType
import com.example.kotlin.chat.repository.Message
import com.example.kotlin.chat.repository.MessageRepository
import com.example.kotlin.chat.service.MessageVM
import com.example.kotlin.chat.service.UserVM
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.AfterEach
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.ValueSource
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.boot.test.web.client.TestRestTemplate
import org.springframework.boot.test.web.client.postForEntity
import org.springframework.core.ParameterizedTypeReference
import org.springframework.http.HttpMethod
import org.springframework.http.RequestEntity
import java.net.URI
import java.net.URL
import java.time.Instant
import java.time.temporal.ChronoUnit.MILLIS

@SpringBootTest(
        webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT,
        properties = [
            "spring.datasource.url=jdbc:h2:mem:testdb"
        ]
)
class ChatKotlinApplicationTests {

    @Autowired
    lateinit var client: TestRestTemplate

    @Autowired
    lateinit var messageRepository: MessageRepository

    lateinit var lastMessageId: String

    val now: Instant = Instant.now()
}
-----

æˆ‘ä»¬ä½¿ç”¨ lateinit å…³é”®å­—ï¼Œ å®ƒéå¸¸é€‚ç”¨äºå»¶è¿Ÿéç©ºå­—æ®µåˆå§‹åŒ–çš„åœºæ™¯ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ç”¨å®ƒå» `@Autowire` é‚£ä¸ª `MessageRepository` å­—æ®µï¼Œå¹¶ä¸”è§£æ `TestRestTemplate`ã€‚

ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä¼šæµ‹è¯•ä»¥ä¸‹ä¸‰ä¸ªä¸€èˆ¬ç”¨ä¾‹ï¼š

* å½“ `lastMessageId` ä¸å¯ç”¨æ—¶è§£ææ¶ˆæ¯çš„æƒ…å†µ
* å½“ `lastMessageId` å­˜åœ¨æ—¶ è§£ææ¶ˆæ¯çš„æƒ…å†µ
* ä»¥åŠå‘é€æ¶ˆæ¯ã€‚

ä¸ºäº†æµ‹è¯•æ¶ˆæ¯çš„è§£ææƒ…å†µï¼Œ æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€äº›æµ‹è¯•æ¶ˆæ¯ï¼Œå¹¶ä¸”éœ€è¦åœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹å®Œæˆåæ¸…ç©ºå­˜å‚¨çš„å†…å®¹ã€‚ æ·»åŠ ä»¥ä¸‹å†…å®¹åˆ° `ChatKotlinApplicationTests`: 


[source,kotlin]
-----
@BeforeEach
fun setUp() {
    val secondBeforeNow = now.minusSeconds(1)
    val twoSecondBeforeNow = now.minusSeconds(2)
    val savedMessages = messageRepository.saveAll(listOf(
            Message(
                    "*testMessage*",
                    ContentType.PLAIN,
                    twoSecondBeforeNow,
                    "test",
                    "http://test.com"
            ),
            Message(
                    "**testMessage2**",
                    ContentType.PLAIN,
                    secondBeforeNow,
                    "test1",
                    "http://test.com"
            ),
            Message(
                    "`testMessage3`",
                    ContentType.PLAIN,
                    now,
                    "test2",
                    "http://test.com"
            )
    ))
    lastMessageId = savedMessages.first().id ?: ""
}

@AfterEach
fun tearDown() {
    messageRepository.deleteAll()
}
-----


ä¸€æ—¦å‡†å¤‡å·¥ä½œå®Œæˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè·å–æ¶ˆæ¯åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

[source,kotlin]
-----
@ParameterizedTest
@ValueSource(booleans = [true, false])
fun `test that messages API returns latest messages`(withLastMessageId: Boolean) {
    val messages: List<MessageVM>? = client.exchange(
        RequestEntity<Any>(
            HttpMethod.GET,
            URI("/api/v1/messages?lastMessageId=${if (withLastMessageId) lastMessageId else ""}")
            ),
            object : ParameterizedTypeReference<List<MessageVM>>() {}).body

    if (!withLastMessageId) {
        assertThat(messages?.map { with(it) { copy(id = null, sent = sent.truncatedTo(MILLIS))}})
                .first()
                .isEqualTo(MessageVM(
                        "*testMessage*",
                        UserVM("test", URL("http://test.com")),
                        now.minusSeconds(2).truncatedTo(MILLIS)
                ))
    }

    assertThat(messages?.map { with(it) { copy(id = null, sent = sent.truncatedTo(MILLIS))}})
            .containsSubsequence(
                    MessageVM(
                            "**testMessage2**",
                            UserVM("test1", URL("http://test.com")),
                            now.minusSeconds(1).truncatedTo(MILLIS)
                    ),
                    MessageVM(
                            "`testMessage3`",
                            UserVM("test2", URL("http://test.com")),
                            now.truncatedTo(MILLIS)
                    )
            )
}
-----

ğŸ’¡ æ‰€æœ‰çš„æ•°æ®ç±»éƒ½æœ‰ä¸€ä¸ª `copy` æ–¹æ³•ï¼Œå¯è®©ä½ å®Œå…¨æ‹·è´ä¸€ä¸ªå®ä¾‹çš„åŒæ—¶è¿˜å¯ä»¥æŒ‰éœ€è‡ªå®šä¹‰æŸäº›å­—æ®µã€‚ åœ¨æˆ‘ä»¬ä¾‹å­ä¸­ï¼Œè¿™æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³æˆªçŸ­å·²å‘é€æ¶ˆæ¯çš„æ—¶é—´æˆ³ä½¿ä¹‹æˆä¸ºåŒæ ·çš„æ—¶é—´å•ä½ï¼Œä»¥ä¾¿æˆ‘ä»¬æ¯”è¾ƒæ—¶é—´æˆ³ã€‚


ğŸ’¡ Kotlin å¯¹å­—ç¬¦ä¸²æ¨¡æ¿çš„æ”¯æŒæ˜¯å¯¹æµ‹è¯•çš„å¾ˆå¥½çš„é™„åŠ ã€‚

ä¸€æ—¦æˆ‘ä»¬å®ç°äº†è¿™ä¸ªæµ‹è¯•ï¼Œæœ€åéœ€è¦å®ç°çš„å°±æ˜¯æ¶ˆæ¯å‘é€æµ‹è¯•ã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° `ChatKotlinApplicationTests` æ–‡ä»¶ï¼š

[source,kotlin]
-----
@Test
fun `test that messages posted to the API is stored`() {
    client.postForEntity<Any>(
            URI("/api/v1/messages"),
            MessageVM(
                    "`HelloWorld`",
                    UserVM("test", URL("http://test.com")),
                    now.plusSeconds(1)
            )
    )

    messageRepository.findAll()
            .first { it.content.contains("HelloWorld") }
            .apply {
                assertThat(this.copy(id = null, sent = sent.truncatedTo(MILLIS)))
                        .isEqualTo(Message(
                                "`HelloWorld`",
                                ContentType.PLAIN,
                                now.plusSeconds(1).truncatedTo(MILLIS),
                                "test",
                                "http://test.com"
                        ))
            }
}
-----

ğŸ’¡ åœ¨æµ‹è¯•æ–¹æ³•ä¸­å¯ä»¥ä½¿ç”¨åå¼•å·æ‹¬èµ·åŒ…å«ç©ºæ ¼çš„å‡½æ•°å‘½ã€‚ è§ç›¸å…³æ–‡æ¡£ https://kotlinlang.org/docs/reference/coding-conventions.html#function-names[documentation].


ä¸Šé¢çš„æµ‹è¯•çœ‹èµ·æ¥è·Ÿä¹‹å‰çš„ç›¸ä¼¼ï¼Œé™¤äº†æˆ‘ä»¬è¦ç¡®è®¤å·²å‘é€çš„æ¶ˆæ¯æ˜¯å­˜åœ¨æ•°æ®åº“ä¸­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `run` ä½œç”¨åŸŸçš„å‡½æ•°ï¼Œè¿™å¯ä»¥ä½¿å¾—åœ¨è°ƒç”¨ä½œç”¨åŸŸå†…çš„ç›®æ ‡å¯¹è±¡ä½œä¸º `this` ã€‚


ä¸€æ—¦æˆ‘ä»¬å®ç°äº†æ‰€æœ‰è¿™äº›æµ‹è¯•ï¼Œ æˆ‘ä»¬å¯ä»¥è¿è¡Œå®ƒä»¬çœ‹æ˜¯å¦å¯ä»¥é€šè¿‡ã€‚


image::{images}/intellij-running-tests.png[]

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ä¸ºèŠå¤©åº”ç”¨æ·»åŠ äº†æ¶ˆæ¯æŒä¹…åŒ–åŠŸèƒ½ã€‚ è¿™äº›æ¶ˆæ¯ç°åœ¨å¯ä»¥ä¼ é€åˆ°æ‰€æœ‰è¿æ¥åˆ°åº”ç”¨ç¨‹åºçš„æ´»åŠ¨å®¢æˆ·ç«¯ã€‚
å¦å¤–ï¼Œæˆ‘ä»¬ç°åœ¨ä¹Ÿå¯ä»¥è®¿é—®å†å²æ•°æ®ï¼Œæ‰€ä»¥æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®åˆ°ä¹‹å‰çš„æ¶ˆæ¯ï¼Œå¦‚æœä»–ä»¬æƒ³çš„è¯ã€‚


è¿™ä¸ªå®ç°çœ‹èµ·æ¥å¯èƒ½å®Œæˆäº†ï¼Œä½†æˆ‘ä»¬å†™çš„ä»£ç è¿˜æœ‰äº›æå‡çš„ç©ºé—´ã€‚ å› ä¸ºï¼Œåœ¨ä¸‹ä¸€ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬ä¼šçœ‹çœ‹ä½¿ç”¨Kotlinæ‰©å±•å¯ä»¥å¦‚ä½•æ”¹å–„æˆ‘ä»¬çš„ä»£ç ã€‚

== ç¬¬3éƒ¨åˆ†: å®ç°æ‰©å±•

åœ¨è¿™éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šå®ç° æ‰©å±•å‡½æ•° ä»¥åœ¨ä¸€äº›åœ°æ–¹å‡å°‘é‡å¤ä»£ç çš„æ•°é‡ã€‚

ä¾‹å¦‚ï¼Œä½ å¯èƒ½æ³¨æ„åˆ° `Message` &lt;--> `MessageVM` çš„è½¬æ¢å½“å‰æ˜¯æ˜¾å¼åœ°å‘ç”Ÿåœ¨ `PersistableMessageService` ã€‚æˆ‘ä»¬åŒæ ·æƒ³è¦é€šè¿‡æ·»åŠ  Markdown æ”¯æŒå»æ”¯æŒä¸åŒçš„å†…å®¹ç±»å‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ä¸º `Message` å’Œ `MessageVM` åˆ›å»ºæ‰©å±•æ–¹æ³•ã€‚ æ–°çš„æ–¹æ³•å®ç°äº† `Message` å’Œ `MessageVM` æ¥å›è½¬æ¢çš„é€»è¾‘ï¼š 


[source,kotlin]
-----
import com.example.kotlin.chat.repository.ContentType
import com.example.kotlin.chat.repository.Message
import com.example.kotlin.chat.service.MessageVM
import com.example.kotlin.chat.service.UserVM
import java.net.URL

fun MessageVM.asDomainObject(contentType: ContentType = ContentType.PLAIN): Message = Message(
        content,
        contentType,
        sent,
        user.name,
        user.avatarImageLink.toString(),
        id
)

fun Message.asViewModel(): MessageVM = MessageVM(
        content,
        UserVM(username, URL(userAvatarImageLink)),
        sent,
        id
)
-----


âŒ¨ï¸   æˆ‘ä»¬ä¼šå°†ä¸Šé¢çš„å‡½æ•°å­˜æ”¾åœ¨ `src/main/kotlin/com/example/kotlin/chat/Extensions.kt` æ–‡ä»¶ä¸­ã€‚

ç°åœ¨æ—¢ç„¶æˆ‘ä»¬å·²ç»æ‰©å±•äº† `MessageMV` å’Œ `Message` ï¼Œ æˆ‘ä»¬å¯ä»¥åœ¨ `PersistentMessageService` ä¸­ä½¿ç”¨å®ƒä»¬äº†ã€‚



[source,kotlin]
-----
@Service
class PersistentMessageService(val messageRepository: MessageRepository) : MessageService {

    override fun latest(): List<MessageVM> =
            messageRepository.findLatest()
                    .map { it.asViewModel() }

    override fun after(lastMessageId: String): List<MessageVM> =
            messageRepository.findLatest(lastMessageId)
                    .map { it.asViewModel() }

    override fun post(message: MessageVM) {
        messageRepository.save(message.asDomainObject())
    }
}
-----

ä¸Šè¾¹çš„ä»£ç æ¯”ä¹‹å‰çš„å¥½ã€‚ å®ƒæ›´ç®€ä»‹å’Œæ˜“è¯»äº†ã€‚ ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥åœ°æ”¹å–„å®ƒã€‚ æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œå¸¦åŒæ ·mapperçš„map()æ“ä½œç¬¦æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤æ¬¡ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸º `List` æ·»åŠ ä¸€ä¸ªå¸¦æŒ‡å®šæ³›å‹çš„è‡ªå®šä¹‰ `map` å‡½æ•°å»æ”¹å–„è¿™ç§æƒ…å†µã€‚ æ·»åŠ ä¸‹é¢è¿™è¡Œåˆ° `Extensions.kt` æ–‡ä»¶ï¼š


[source,kotlin]
-----
fun List<Message>.mapToViewModel(): List<MessageVM> = map { it.asViewModel() }
-----

åŠ ä¸Šäº†è¿™ä¸€è¡Œä¹‹åï¼Œ Kotlin ä¼šæä¾›ç›¸å…³çš„æ‰©å±•æ–¹æ³•åˆ°ä¸æŒ‡å®šæ³›å‹ç±»å‹å¯¹åº”çš„ä»»æ„`List`ï¼š

[source,kotlin]
-----
@Service
class PersistentMessageService(val messageRepository: MessageRepository) : MessageService {

    override fun latest(): List<MessageVM> =
        messageRepository.findLatest()
            .mapToViewModel() // now we can use the mentioned extension on List<Message>

    override fun after(lastMessageId: String): List<MessageVM> =
        messageRepository.findLatest(lastMessageId)
            .mapToViewModel()
    //...
}
-----

âš ï¸ æ³¨æ„ä½ ä¸èƒ½åœ¨åŒä¸€ä¸ªç±»ã€åŒæ ·çš„æ‰©å±•åç§°ä¸èƒ½ä½¿ç”¨ä¸åŒçš„æ³›å‹ã€‚åŸå› æ˜¯ç±»å‹æ“¦é™¤ï¼Œè¿™æ„å‘³ç€åœ¨è¿è¡Œæ—¶ï¼Œä¸åŒçš„ç±»éƒ½æ˜¯ä½¿ç”¨åŒæ ·çš„æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒæ˜¯æ²¡åŠæ³•çŒœæµ‹åº”è¯¥è°ƒç”¨å“ªä¸€ä¸ªçš„ã€‚

ä¸€æ—¦æ‰€æœ‰çš„æ‰©å±•åº”ç”¨ä¸Šäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„æŠ€å·§åœ¨æµ‹è¯•çš„ç±»é‡Œé¢å£°æ˜æ”¯æŒçš„æ‰©å±•ã€‚å°†ä»¥ä¸‹ä»£ç æ”¾åˆ° `src/test/kotlin/com/example/kotlin/chat/TestExtensions.kt` æ–‡ä»¶ä¸­ã€‚

[source,kotlin]
-----
import com.example.kotlin.chat.repository.Message
import com.example.kotlin.chat.service.MessageVM
import java.time.temporal.ChronoUnit.MILLIS

fun MessageVM.prepareForTesting() = copy(id = null, sent = sent.truncatedTo(MILLIS))

fun Message.prepareForTesting() = copy(id = null, sent = sent.truncatedTo(MILLIS))
-----

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­å®ç°å¯¹ `MARKDOWN` å†…å®¹ç±»å‹çš„æ”¯æŒã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ Markdownå†…å®¹æ¸²æŸ“çš„å·¥å…·åŒ…ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ æ¥è‡ª JetBrains å®˜æ–¹çš„ Markdown åº“ä¾èµ–åˆ°æˆ‘ä»¬çš„ `build.gradle.kts` æ–‡ä»¶ã€‚

[source]
-----
dependencies {
   ...
   implementation("org.jetbrains:markdown:0.1.45")
   ...
}
-----

æ—¢ç„¶æˆ‘ä»¬å·²ç»å­¦åˆ°äº†å¦‚ä½•ä½¿ç”¨æ‰©å±•ï¼Œ è®©æˆ‘ä»¬åœ¨ `Extensions.kt` æ–‡ä»¶ä¸­åˆ›å»ºå¦ä¸€ä¸ª `ContentType` enum çš„æ‰©å±•ï¼Œè¿™æ ·æ¯ä¸ª enum å€¼ä¼šçŸ¥é“å¦‚ä½•æ¸²æŸ“ç‰¹å®šçš„å†…å®¹ã€‚

[source,kotlin]
-----
fun ContentType.render(content: String): String = when (this) {
    ContentType.PLAIN -> content
}
-----

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ æˆ‘ä»¬ä½¿ç”¨äº† `when` è¡¨è¾¾å¼ï¼Œ å®ƒæä¾›äº† Kotlin ä¸­çš„æ¨¡å¼åŒ¹é…ã€‚ å¦‚æœ `when` æ˜¯ç”¨ä½œè¡¨è¾¾å¼ï¼Œ é‚£ä¹ˆ `else` åˆ†æ”¯æ˜¯å¿…é¡»çš„ã€‚ ç„¶è€Œï¼Œ å¦‚æœ `when` æ˜¯ç”¨äºå¯ç©·ä¸¾çš„å€¼ï¼ˆä¾‹å¦‚ï¼Œæœ‰å¸¸æ•°ä¸ªè¾“å‡ºç»“æœçš„ `enum`  æˆ– æœ‰å®šä¹‰ä¸€å®šæ•°é‡çš„å­ç±»çš„ `sealed classes`ï¼‰ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ `else` åˆ†æ”¯å°±ä¸æ˜¯å¿…è¦çš„ã€‚ ä¸Šé¢çš„ä¾‹å­æ­£æ˜¯è¿™æ ·çš„ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ç¼–è¯‘æœŸå°±çŸ¥é“äº†æ‰€æœ‰çš„å¯èƒ½è¾“å‡ºï¼ˆè€Œä¸”æ‰€æœ‰çš„éƒ½å¤„ç†å¥½äº†ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦æŒ‡å®š `else` åˆ†æ”¯ã€‚

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº† `when` è¡¨è¾¾å¼çš„åŸç†ï¼Œè®©æˆ‘ä»¬æœ€åå†æ·»åŠ ç¬¬äºŒä¸ªé€‰é¡¹åˆ° `ContentType` enum:

[source,kotlin]
-----
enum class ContentType {
    PLAIN, MARKDOWN
}
-----

`when` è¡¨è¾¾å¼å¼ºå¤§ä¹‹å¤„ä½“ç°åœ¨æœ‰å¼ºçƒˆçš„ç©·ä¸¾æ€§éœ€æ±‚çš„æ—¶å€™ã€‚ä»»ä½•æ—¶å€™å½“ä¸€ä¸ªæ–°çš„å€¼æ·»åŠ åˆ°äº† `enum`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¨é€è½¯ä»¶åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰ä¿®å¤ç¼–è¯‘é—®é¢˜ï¼š

[source,kotlin]
-----
fun ContentType.render(content: String): String = when (this) {
    ContentType.PLAIN -> content
    ContentType.MARKDOWN -> {
        val flavour = CommonMarkFlavourDescriptor()
        HtmlGenerator(content, MarkdownParser(flavour).buildMarkdownTreeFromString(content),
           flavour).generateHtml()
    }
}
-----

å½“æˆ‘ä»¬ä¿®å¤äº† `render` æ–¹æ³•ä»¥æ”¯æŒæ–°çš„ `ContentType` ï¼Œ æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ `Message` å’Œ `MessageVM` çš„æ‰©å±•æ–¹æ³•å»å¯ç”¨ `MARKDOWN` ç±»å‹æ¸²æŸ“ç›¸åº”çš„å†…å®¹:

[source,kotlin]
-----
fun MessageVM.asDomainObject(contentType: ContentType = ContentType.MARKDOWN): Message = Message(
        content,
        contentType,
        sent,
        user.name,
        user.avatarImageLink.toString(),
        id
)

fun Message.asViewModel(): MessageVM = MessageVM(
        contentType.render(content),
        UserVM(username, URL(userAvatarImageLink)),
        sent,
        id
)
-----

æˆ‘ä»¬ä¹Ÿéœ€è¦ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹ç¡®ä¿ `MARKDOWN` å†…å®¹ç±»å‹è¢«æ­£ç¡®åœ°æ¸²æŸ“ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ”¹ `ChatKotlinApplicationTests.kt` å¹¶ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š

[source,kotlin]
-----
@BeforeEach
fun setUp() {
    //...
            Message(
                    "*testMessage*",
                    ContentType.PLAIN,
                    twoSecondBeforeNow,
                    "test",
                    "http://test.com"
            ),
            Message(
                    "**testMessage2**",
                    ContentType.MARKDOWN,
                    secondBeforeNow,
                    "test1",
                    "http://test.com"
            ),
            Message(
                    "`testMessage3`",
                    ContentType.MARKDOWN,
                    now,
                    "test2",
                    "http://test.com"
            )
   //...
}

@ParameterizedTest
@ValueSource(booleans = [true, false])
fun `test that messages API returns latest messages`(withLastMessageId: Boolean) {
    //...

    assertThat(messages?.map { it.prepareForTesting() })
            .containsSubsequence(
                    MessageVM(
                            "<body><p><strong>testMessage2</strong></p></body>",
                            UserVM("test1", URL("http://test.com")),
                            now.minusSeconds(1).truncatedTo(MILLIS)
                    ),
                    MessageVM(
                            "<body><p><code>testMessage3</code></p></body>",
                            UserVM("test2", URL("http://test.com")),
                            now.truncatedTo(MILLIS)
                    )
            )
}

@Test
fun `test that messages posted to the API are stored`() {
    //...
    messageRepository.findAll()
            .first { it.content.contains("HelloWorld") }
            .apply {
                assertThat(this.prepareForTesting())
                        .isEqualTo(Message(
                                "`HelloWorld`",
                                ContentType.MARKDOWN,
                                now.plusSeconds(1).truncatedTo(MILLIS),
                                "test",
                                "http://test.com"
                        ))
            }
}
-----

ä¿®æ”¹ä¸ºå®Œæˆåï¼Œ æˆ‘ä»¬ä¼šçœ‹åˆ°å…¨éƒ¨çš„æµ‹è¯•ä»èƒ½é€šè¿‡ï¼Œ è€Œä¸” `MARKDOWN` å†…å®¹ç±»å‹èƒ½è¢«æŒ‰ç…§é¢„æœŸåœ°æ¸²æŸ“ã€‚

åœ¨è¿™ä¸€æ­¥ï¼Œ æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨æ‰©å±•å»æ”¹å–„ä»£ç è´¨é‡ã€‚ æˆ‘ä»¬ä¹Ÿå­¦ä¹ äº† `when` è¡¨è¾¾å¼ä»¥åŠå®ƒæ˜¯å¦‚ä½•åœ¨æ·»åŠ æ–°çš„ä¸šåŠ¡ç‰¹æ€§æ—¶å‡å°‘äººä¸ºé”™è¯¯çš„ã€‚

== ç¬¬4éƒ¨åˆ†ï¼šé‡æ„ä»£ç ä¸ºåœ¨ Spring WebFlux ä¸­ä½¿ç”¨ Kotlin åç¨‹

åœ¨æ•™ç¨‹çš„è¿™éƒ¨åˆ†ï¼Œ æˆ‘ä»¬ä¼šä¿®æ”¹ä»£ç æ·»åŠ  Kotlin åç¨‹çš„æ”¯æŒã€‚

æœ¬è´¨ä¸Šï¼Œ åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹ä½¿å¾—å¼‚æ­¥ä»£ç å¯ä»¥ç”¨å‘½ä»¤å¼è¡¨è¾¾ã€‚è¿™å°±è§£å†³äº†å¾ˆå¤šä¸å›è°ƒï¼ˆè§‚å¯Ÿè€…ï¼‰æ¨¡å¼ç›¸å…³çš„é—®é¢˜ï¼Œä¸Šé¢å°±ä½¿ç”¨äº†è¿™æ ·çš„æ–¹å¼å»è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚

âš ï¸ åœ¨æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬ä¸ä¼šæ·±å…¥è®²åç¨‹ä»¥åŠ *kotilnx.coroutines* æ ‡å‡†åº“ã€‚ æƒ³å­¦ä¹ åç¨‹åŠå…¶ç‰¹æ€§ï¼Œè¯·çœ‹ä»¥ä¸‹æ•™ç¨‹ https://play.kotlinlang.org/hands-on/Introduction%20to%20Coroutines%20and%20Channels/01_Introduction[tutorial].


=== æ·»åŠ åç¨‹

è¦å¼€å§‹ä½¿ç”¨ Kotlin åç¨‹ï¼Œ æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸‰ä¸ªé¢å¤–çš„åº“åˆ° `build.gradle.kts`æ–‡ä»¶ï¼š

[source]
-----
dependencies {
    ...
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core")
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-reactive")
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-reactor")
    ...
}
-----

ä¸€æ—¦æˆ‘ä»¬æ·»åŠ å®Œäº†ä¾èµ–ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä½¿ç”¨åç¨‹ç›¸å…³çš„ä¸»è¦å…³é”®å­—ï¼š `suspend`. è¿™ä¸ª `suspend` å…³é”®å­—è¡¨ç¤ºè¢«è°ƒç”¨çš„å‡½æ•°æ˜¯å¼‚æ­¥çš„ã€‚ ä¸åƒå…¶å®ƒçš„è¯­è¨€ï¼Œç±»ä¼¼çš„æ¦‚å¿µæ˜¯é€šè¿‡ `async` æˆ– `await` å…³é”®å­—è¡¨è¾¾ï¼Œ
é‚£ä¸ª `suspend` å‡½æ•°å¿…é¡»åœ¨åç¨‹ä¸Šä¸‹æ–‡å¤„ç†ï¼Œå®ƒè¦ä¹ˆæ˜¯å¦ä¸€ä¸ª `suspend` å‡½æ•°æˆ–è€…æ˜¯ä¸€ä¸ªé€šè¿‡ `CoroutineScope.launch` æ˜¾å¼åˆ›å»ºçš„åç¨‹ `Job` æˆ–è€…æ˜¯ `runBlocking` å‡½æ•°ã€‚

å› æ­¤ï¼Œ ä½œä¸ºå°†åç¨‹å¼•å…¥æˆ‘ä»¬å·¥ç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¼šæ·»åŠ  `suspend` å…³é”®å­—åˆ°å·¥ç¨‹é‡Œæ‰€æœ‰çš„ controllers å’Œ service æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œä¿®æ”¹ä¹‹åçš„ä»£ç ï¼Œ é‚£ä¸ª `MessageService` æ¥å£çœ‹èµ·æ¥åƒæ˜¯è¿™æ ·çš„ï¼š

[source,kotlin]
-----
interface MessageService {

    suspend fun latest(): List<MessageVM>

    suspend fun after(lastMessageId: String): List<MessageVM>

    suspend fun post(message: MessageVM)
}
-----


ä¸Šé¢çš„ä¿®æ”¹ä¹Ÿä¼šå½±å“åˆ°ä»£ç ä¸­ç”¨åˆ° `MessageService` çš„åœ°æ–¹ã€‚æ‰€æœ‰åœ¨ `PersistentMessageService` ä¸­çš„å‡½æ•°éƒ½è¦ç›¸åº”åœ°æ›´æ–°ä¸ºå¸¦ `suspend` å…³é”®å­—ã€‚



[source,kotlin]
-----
@Service
class PersistentMessageService(val messageRepository: MessageRepository) : MessageService {

   override suspend fun latest(): List<MessageVM> =
       messageRepository.findLatest()
           .mapToViewModel()

   override suspend fun after(messageId: String): List<MessageVM> =
       messageRepository.findLatest(messageId)
           .mapToViewModel()

   override suspend fun post(message: MessageVM) {
       messageRepository.save(message.asDomainObject())
   }
}
-----

å¤„ç†è¯·æ±‚çš„ `HtmlController` å’Œ `MessageResource` ä¹Ÿéƒ½éœ€è¦è°ƒæ•´ï¼š

[source,kotlin]
-----
// src/main/kotlin/com/example/kotlin/chat/controller/HtmlController.kt

@Controller
class HtmlController(val messageService: MessageService) {

   @GetMapping("/")
   suspend fun index(model: Model): String {
       //...
   }
}
-----

[source,kotlin]
-----
// src/main/kotlin/com/example/kotlin/chat/controller/MessageResource.kt

@RestController
@RequestMapping("/api/v1/messages")
class MessageResource(val messageService: MessageService) {

   @GetMapping
   suspend fun latest(@RequestParam(value = "lastMessageId", defaultValue = "") lastMessageId: String): ResponseEntity<List<MessageVM>> {
       //...
   }

   @PostMapping
   suspend fun post(@RequestBody message: MessageVM) {
       //...
   }
}
-----


ç°åœ¨æˆ‘ä»¬å·²å‡†å¤‡å¥½å°†ä»£ç è¿ç§»åˆ°å“åº”å¼ Spring æŠ€æœ¯æ ˆäº†ï¼ŒWebFlux. ç»§ç»­çœ‹ä¸‹å»å§ï¼


=== æ·»åŠ  WebFlux å’Œ R2DBC

å°½ç®¡å¤§å¤šæ•°æƒ…å†µä¸‹æ·»åŠ  `org.jetbrains.kotlinx:kotlinx-coroutines-core` ä¾èµ–å°±å¤Ÿäº†ï¼Œä¸ºäº†æ°å½“åœ°ä¸ Spring æ¡†æ¶é›†æˆï¼Œæˆ‘ä»¬éœ€è¦æ›¿æ¢æ‰ web å’Œ æ•°æ®åº“æ¨¡å—ï¼š


[source]
-----
dependencies {
    ...
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("org.springframework.boot:spring-boot-starter-data-jdbc")
    ...
}
-----

ä¸ºä»¥ä¸‹å†…å®¹ï¼š

[source]
-----
dependencies {
    ...
    implementation("org.springframework.boot:spring-boot-starter-webflux")
    implementation("org.springframework.boot:spring-boot-starter-data-r2dbc")
    implementation("io.r2dbc:r2dbc-h2")
    ...
}
-----

é€šè¿‡æ·»åŠ ä¸Šé¢çš„ä¾èµ–ï¼Œæˆ‘ä»¬ç”¨å®Œå…¨å“åº”å¼(ååº”å¼)ä¸”éé˜»å¡çš„ WebFlux æ›¿æ¢æ‰äº†æ ‡å‡†çš„é˜»å¡å¼çš„ Web MVCã€‚ è¿˜æœ‰å°±æ˜¯ï¼ŒJDBC ä¹Ÿæ›¿æ¢ä¸ºå®Œå…¨å“åº”å¼ä¸”éé˜»å¡çš„ R2DBCã€‚


å¹¸å¥½æœ‰æ‰€æœ‰ Spring æ¡†æ¶å·¥ç¨‹å¸ˆä»¬çš„è¾›å‹¤åŠ³åŠ¨ï¼Œä» Spring Web MVC è¿ç§»åˆ° WebFlux æ˜¯é¡ºæ»‘çš„ï¼Œæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸ç”¨é‡å†™ï¼ ç„¶è€Œå¯¹äº R2DBC, æˆ‘ä»¬éœ€è¦ä¸€äº›é¢å¤–æ­¥éª¤ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªé…ç½®ç±»ã€‚


âŒ¨ï¸   æˆ‘ä»¬å°†è¿™ä¸ªç±»æ”¾åˆ° `com/example/kotlin/chat/ChatKotlinApplication.kt` æ–‡ä»¶ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åº `main()` æ–¹æ³•æ‰€åœ¨çš„åœ°æ–¹ã€‚

[source,kotlin]
-----
@Configuration
class Config {

    @Bean
    fun initializer(connectionFactory: ConnectionFactory): ConnectionFactoryInitializer {
        val initializer = ConnectionFactoryInitializer()
        initializer.setConnectionFactory(connectionFactory)
        val populator = CompositeDatabasePopulator()
        populator.addPopulators(ResourceDatabasePopulator(ClassPathResource("./sql/schema.sql")))
        initializer.setDatabasePopulator(populator)
        return initializer
    }
}
-----

ä¸Šé¢çš„é…ç½®ç¡®ä¿äº†æ•°æ®è¡¨çš„æ¨¡å¼åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ä¼šè¢«åˆå§‹åŒ–ã€‚


æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ `application.properties` çš„å±æ€§ä»¥åŒ…å«ä¸€ä¸ªå±æ€§ï¼š


[source,properties]
-----
spring.r2dbc.url=r2dbc:h2:file:///./build/data/testdb;USER=sa;PASSWORD=password
-----

å½“æˆ‘ä»¬ä½œäº†ä¸€äº›åŸºç¡€é…ç½®ç›¸å…³çš„æ›´æ”¹ï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œä» Spring Data JDBC åˆ° Spring Data R2DBC çš„è¿ç§»ã€‚ ä¸ºæ­¤æˆ‘ä»¬éœ€è¦æ›´æ–° `MessageRepository` æ¥å£åˆ°ä» `CoroutineCrudRepository` ç»§æ‰¿ï¼Œå¹¶ä½¿ç”¨
`suspend` å…³é”®å­—æ ‡è®°å®ƒçš„æ–¹æ³•ã€‚ å°±åƒè¿™è¾¹ä»£ç æ‰€ç¤ºï¼š


[source,kotlin]
-----
interface MessageRepository : CoroutineCrudRepository<Message, String> {

    // language=SQL
    @Query("""
        SELECT * FROM (
            SELECT * FROM MESSAGES
            ORDER BY "SENT" DESC
            LIMIT 10
        ) ORDER BY "SENT"
    """)
    suspend fun findLatest(): List<Message>

    // language=SQL
    @Query("""
        SELECT * FROM (
            SELECT * FROM MESSAGES
            WHERE SENT > (SELECT SENT FROM MESSAGES WHERE ID = :id)
            ORDER BY "SENT" DESC
        ) ORDER BY "SENT"
    """)
    suspend fun findLatest(@Param("id") id: String): List<Message>
}
-----

`CoroutineCrudRepository` é‡Œçš„æ–¹æ³•çš„è®¾è®¡éƒ½æœ‰è€ƒè™‘åˆ° Kotlin åç¨‹çš„ã€‚

âš ï¸ æ³¨æ„åˆ°é‚£ä¸ª `@Query` æ³¨è§£ç°åœ¨æ˜¯åœ¨ä¸åŒçš„åŒ…äº†ï¼Œæ‰€ä»¥éœ€è¦æŒ‰ä¸‹é¢è¿™æ ·å­å¯¼å…¥å®ƒï¼š

[source,kotlin]
-----
import org.springframework.data.r2dbc.repository.Query
-----

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œè¿™äº›æ›´æ”¹åº”è¯¥è¶³ä»¥è®©ä½ çš„åº”ç”¨å˜æˆå¼‚æ­¥å’Œéé˜»å¡çš„äº†ã€‚ å½“é‡æ–°è¿è¡Œåº”ç”¨ï¼Œä»åŠŸèƒ½çš„è§’åº¦çœ‹ï¼Œæ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œä½†ç°åœ¨å®ƒä½¿å¼‚æ­¥éé˜»å¡åœ°æ‰§è¡Œäº†ã€‚

æœ€åï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¿®æ”¹ä»¥ä¸‹æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ã€‚ å› ä¸ºç°åœ¨æˆ‘ä»¬çš„ `MessageRepository` æ˜¯å¼‚æ­¥çš„äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æ•°æ®æºçš„ URL å¹¶ä¸”åœ¨åç¨‹çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œç›¸å…³çš„æ“ä½œï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºï¼Œç”¨ `runBlocking` å°†ä»£ç åŒ…èµ·æ¥ï¼ˆåœ¨ `ChatKotlinApplicationTests.kt` æ–‡ä»¶ä¸­ï¼š

[source,kotlin]
-----
// ...
// new imports
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.runBlocking

@SpringBootTest(
        webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT,
        properties = [
            "spring.r2dbc.url=r2dbc:h2:mem:///testdb;USER=sa;PASSWORD=password"
        ]
)
class ChatKotlinApplicationTests {
    //...

    @BeforeEach
    fun setUp() {
       runBlocking {
        //...
       }
    }

    @AfterEach
    fun tearDown() {
       runBlocking {
        //...
       }
    }

    //...

    @Test
    fun `test that messages posted to the API is stored`() {
       runBlocking {
        //...
       }
    }
}
-----

æˆ‘ä»¬çš„åº”ç”¨ç°åœ¨å·²ç»æ˜¯å¼‚æ­¥å’Œéé˜»å¡çš„äº†ã€‚ ä¸è¿‡å®ƒè¿˜æ˜¯ä½¿ç”¨è½®è¯¢çš„æ–¹å¼å°†æ¶ˆæ¯ä»åç«¯é€åˆ°å‰ç«¯çš„UIã€‚åœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šå°†åº”ç”¨æ”¹ä¸ºä½¿ç”¨ RSocket æµå¼ä¼ è¾“æ¶ˆæ¯åˆ°æ‰€æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯ã€‚


== ç¬¬5éƒ¨åˆ†ï¼šä½¿ç”¨ RSocket è¿›è¡Œæµå¼ä¼ è¾“

æˆ‘ä»¬ä¼šä½¿ç”¨ RSocket å°†æ¶ˆæ¯ä¼ è¾“è½¬ä¸ºç±»ä¼¼æµå¼ä¼ è¾“çš„æ–¹å¼ã€‚

RSocket æ˜¯ä¸€ç§äºŒè¿›åˆ¶åè®®ç”¨åœ¨åƒ TCP å’Œ WebSocket è¿™æ ·çš„å­—èŠ‚æµä¼ è¾“å±‚ã€‚å®ƒæä¾›äº†å¤šç§ç¼–ç¨‹è¯­è¨€çš„ APIï¼ŒåŒ…æ‹¬ Kotlinã€‚ ç„¶è€Œï¼Œ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ä½¿ç”¨é‚£ä¸ªAPIã€‚æˆ‘ä»¬ä½¿ç”¨ Spring Messagingï¼Œ å®ƒæ•´åˆäº† RSocket å¹¶æä¾›äº†ä¸€ç§åŸºäºæ³¨è§£çš„é…ç½®æ–¹å¼ã€‚

è¦å¼€å§‹åœ¨ Spring ä¸­ä½¿ç”¨ RSocket ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å’Œå¯¼å…¥æ–°çš„ä¾èµ–åˆ° `build.gradle.kts`:

[source]
-----
dependencies {
    ....
     implementation("org.springframework.boot:spring-boot-starter-rsocket")
    ....
}
-----


æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦æ›´æ–° `MessageRepository` è®©å®ƒé€šè¿‡ `Flow&lt;Messages>` è€Œä¸æ˜¯ `List` å»è¿”å›ä¸€ä¸ªå¼‚æ­¥çš„æ¶ˆæ¯æµã€‚

[source,kotlin]
-----
interface MessageRepository : CoroutineCrudRepository<Message, String> {

    //...
    fun findLatest(): Flow<Message>

    //...
    fun findLatest(@Param("id") id: String): Flow<Message>
}
-----

æˆ‘ä»¬éœ€è¦å¯¹ `MessageService` æ¥å£ä½œç±»ä¼¼çš„ä¿®æ”¹ä½¿å®ƒä¸ºæµå¼ä¼ è¾“åšå¥½å‡†å¤‡ã€‚æˆ‘ä»¬ä¸éœ€è¦é‚£ä¸ª `suspend` å…³é”®å­—äº†ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ `Flow` æ¥å£æ¥è¡¨ç¤ºå¼‚æ­¥çš„æ•°æ®æµã€‚ ä»»ä½•ä¹‹å‰è¾“å‡º `List` ç»“æœçš„å‡½æ•°ç°åœ¨å°†ä¼šè¾“å‡º `Flow`ã€‚ å‘é€æ¶ˆæ¯çš„æ–¹æ³•ä¹Ÿå°†ä¼šæ¥å— `Flow` ç±»å‹ä½œä¸ºå‚æ•°ã€‚

[source]
-----
import kotlinx.coroutines.flow.Flow

interface MessageService {

   fun latest(): Flow<MessageVM>

   fun after(messageId: String): Flow<MessageVM>

   fun stream(): Flow<MessageVM>

   suspend fun post(messages: Flow<MessageVM>)
}
-----

ç°åœ¨æ€è·¯æ¸…æ™°äº†ï¼Œå¯ä»¥æ›´æ–° `PersistentMessageService` æ•´åˆä¸Šé¢çš„ä¿®æ”¹äº†ã€‚

[source,kotlin]
-----
import com.example.kotlin.chat.asDomainObject
import com.example.kotlin.chat.asRendered
import com.example.kotlin.chat.mapToViewModel
import com.example.kotlin.chat.repository.MessageRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableSharedFlow
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.onEach
import kotlinx.coroutines.flow.collect
import org.springframework.stereotype.Service

@Service
class PersistentMessageService(val messageRepository: MessageRepository) : MessageService {

   val sender: MutableSharedFlow<MessageVM> = MutableSharedFlow()

   override fun latest(): Flow<MessageVM> =
       messageRepository.findLatest()
           .mapToViewModel()

   override fun after(messageId: String): Flow<MessageVM> =
       messageRepository.findLatest(messageId)
           .mapToViewModel()

   override fun stream(): Flow<MessageVM> = sender

   override suspend fun post(messages: Flow<MessageVM>) =
       messages
           .onEach { sender.emit(it.asRendered()) }
           .map {  it.asDomainObject() }
           .let { messageRepository.saveAll(it) }
           .collect()
}
-----

é¦–å…ˆï¼Œå› ä¸º `MessageService` æ¥å£å·²ç»ä¿®æ”¹äº†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯¹åº”çš„å®ç°æ›´æ–°æ–¹æ³•ç­¾åã€‚ æ‰€ä»¥ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨ `Extension.kt` æ–‡ä»¶ä¸­ä¸º `List` ç±»å‹å®šä¹‰çš„ `mapToViewModel` æ‰©å±•æ–¹æ³•ç°åœ¨éœ€è¦æ”¹ä¸ºé’ˆå¯¹ `Flow` ç±»å‹çš„äº†ã€‚


[source,kotlin]
-----
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.map

fun Flow<Message>.mapToViewModel(): Flow<MessageVM> = map { it.asViewModel() }
-----

ä¸ºå¯è¯»æ€§èµ·è§ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ç»™ `MessageVM` ç±»æ·»åŠ  `asRendered` æ‰©å±•å‡½æ•°ã€‚ åœ¨ `Extensions.kt` æ–‡ä»¶ä¸­ï¼š

[source,kotlin]
-----
fun MessageVM.asRendered(contentType: ContentType = ContentType.MARKDOWN): MessageVM =
   this.copy(content = contentType.render(this.content))
-----

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åç¨‹ APIé‡Œé¢çš„ `MutableSharedFlow` å»å¹¿æ’­æ¶ˆæ¯åˆ°å·²è¿æ¥çš„å®¢æˆ·ç«¯ã€‚

åšäº†ä¿®æ”¹æˆ‘ä»¬å·²ç»æ¥è¿‘æƒ³è¦çš„UIæ•ˆæœäº†ã€‚ ç„¶åï¼Œæˆ‘ä»¬å°†æ›´æ–° `MessageResource` å’Œ `HtmlController`ã€‚

`MessageResource` å®Œå…¨æ˜¯æ–°çš„å®ç°ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ `@MessageMapping` è€Œä¸æ˜¯ `@RequestMapping` æ³¨è§£å»è®©è¿™ä¸ªç±»æ”¯æŒæ¶ˆæ¯é€šä¿¡ã€‚ æ–°çš„æ–¹æ³• `send()` å’Œ `receive()` éƒ½æ˜¯é€šè¿‡ `@MessageMapping` æ˜ å°„åˆ°åŒä¸€ä¸ªç«¯ç‚¹ï¼Œç”¨äºåŒå‘é€šä¿¡ã€‚


[source,kotlin]
-----
@Controller
@MessageMapping("api.v1.messages")
class MessageResource(val messageService: MessageService) {

   @MessageMapping("stream")
   suspend fun receive(@Payload inboundMessages: Flow<MessageVM>) =
       messageService.post(inboundMessages)

   @MessageMapping("stream")
   fun send(): Flow<MessageVM> = messageService
       .stream()
       .onStart {
           emitAll(messageService.latest())
       }
}
-----

ä¸ºäº†å‘é€æ¶ˆæ¯åˆ° UIï¼Œæˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ¥è‡ª `messageService` çš„ `stream`ï¼Œè¿™æ˜¯ç”± `PersistentMessageService` ç±»å®ç°çš„ï¼Œç„¶åè°ƒç”¨ `onStart` æ–¹æ³•å¼€å§‹æµå¼ä¼ è¾“äº‹ä»¶ã€‚å½“ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ï¼Œå®ƒä¼šé¦–å…ˆå—åˆ°å†å²æ¶ˆæ¯ï¼Œè¿™æ˜¯å› ä¸º `onStart` æ–¹æ³•ä¸­ä½œä¸ºå‚æ•°çš„ä¸€æ®µä»£ç : `emitAll(messageService.latest())` ã€‚ ç„¶åè¿™ä¸ªé€šé“å°±ä¿æŒå¼€å¯éšæ—¶å¯ä»¥ä¼ è¾“æ–°æ¶ˆæ¯ã€‚

é‚£ä¸ª `HtmlController` ç±»ä¸å†éœ€è¦å¤„ç†ä»»ä½•æµå¼ä¼ è¾“çš„é€»è¾‘ã€‚å®ƒç°åœ¨çš„ä½œç”¨æ˜¯æœåŠ¡é™æ€é¡µé¢ï¼Œæ‰€ä»¥å®ƒçš„å®ç°å°±å¾ˆç®€å•ï¼ˆæ— å…³ç´§è¦çš„ï¼‰ï¼š


[source,kotlin]
-----
@Controller
class HtmlController() {

   @GetMapping("/")
   fun index(): String {
       // implemented in src/main/resources/templates/chatrs.html
       return "chatrs"
   }
}
-----

æ³¨æ„åˆ°ç°åœ¨ UI æ¨¡æ¿æ˜¯ `chatrs.html` è€Œä¸æ˜¯ `chat.html` äº†ã€‚ æ–°çš„æ¨¡æ¿å¼•æ“åŒ…å«äº† JavaScript ä»£ç ï¼Œç”¨äºé…ç½® _WebSocket_ è¿æ¥å’Œç›´æ¥ä¸ `MessageResource` ç±»å®ç°çš„ `api.v1.messages.stream` ç«¯ç‚¹äº¤äº’ã€‚

æœ€åæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ `application.properties` æ–‡ä»¶ä½¿ä¹‹é€‚ç”¨äº RSocketã€‚ æ·»åŠ ä»¥ä¸‹å±æ€§åˆ°é…ç½®ä¸­ï¼š

[source,properties]
-----
spring.rsocket.server.transport=websocket
spring.rsocket.server.mapping-path=/rsocket
-----

è¿™ä¸ªåº”ç”¨å·²é¢„å¤‡å¥½å¯åŠ¨äº†ï¼å¾—ç›ŠäºRSocketç°åœ¨æ¶ˆæ¯æ— éœ€è½®è¯¢å°±å¯ä»¥ä¼ åˆ°èŠå¤©UIäº†ã€‚è¿˜æœ‰å°±æ˜¯åç«¯åº”ç”¨å®Œå…¨å¼‚æ­¥å’Œéé˜»å¡çš„äº†ï¼Œè¿™å¾—ç›ŠäºSpring WebFluxå’ŒKotlin åç¨‹ã€‚

æˆ‘ä»¬æ•™ç¨‹çš„æœ€åä¸€æ­¥æ˜¯æ›´æ–°è¿™äº›æµ‹è¯•ã€‚

æˆ‘ä»¬éœ€è¦ç‰¹å®šä¸ºæµ‹è¯•æ·»åŠ æ›´å¤šçš„ä¾èµ–ã€‚ Turbine æ˜¯ä¸€ä¸ªå°çš„æµ‹è¯•åº“ã€‚ å®ƒé€šè¿‡æä¾›ä¸€äº›æœ‰ç”¨çš„æ‰©å±•å»ç®€åŒ–äº† kotlinx.coroutines çš„ `Flow` æ¥å£

[source]
-----
dependencies {
    ...
    testImplementation("app.cash.turbine:turbine:0.3.0")
    ...
}
-----

è¿™ä¸ªåº“çš„å…¥å£æ˜¯ `Flow&lt;T&gt;` çš„ `test()` æ‰©å±•ï¼Œå®ƒä»¥ä¸€æ®µå®ç°äº†æ ¡éªŒé€»è¾‘çš„ä»£ç ä½œä¸ºå‚æ•°ã€‚ é‚£ä¸ª `test()` æ‰©å±•æ—¶ä¸€ä¸ªæ‚¬æŒ‚(suspending)å‡½æ•°ï¼Œç›´åˆ°flowå®Œæˆäº†æˆ–å–æ¶ˆäº†æ‰ä¼šè¿”å›ã€‚æˆ‘ä»¬ç¨åä¼šçœ‹çœ‹å®ƒçš„ç”¨å¤„ã€‚

æ¥ä¸‹æ¥ï¼Œæ›´æ–°æµ‹è¯•ä¾èµ–ã€‚ æˆ‘ä»¬ä¸é€šè¿‡å­—æ®µè‡ªåŠ¨è£…é…ï¼Œè€Œæ˜¯ä½¿ç”¨æ„é€ å™¨æ³¨å…¥ä¾èµ–ã€‚

[source,kotlin]
-----
class ChatKotlinApplicationTests {

   @Autowired
   lateinit var client: TestRestTemplate

   @Autowired
   lateinit var messageRepository: MessageRepository

class ChatKotlinApplicationTests(
   @Autowired val rsocketBuilder: RSocketRequester.Builder,
   @Autowired val messageRepository: MessageRepository,
   @LocalServerPort val serverPort: Int
) {
-----

æˆ‘ä»¬ä½¿ç”¨ `RSocketRequest.Builder` è€Œä¸æ˜¯ `TestRestTemplate`å› ä¸ºç”± `MessageResource` å®ç°çš„ç«¯ç‚¹æ˜¯é€šè¿‡ RSocket åè®®é€šä¿¡çš„ã€‚åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ª `RSocketRequester` å®ä¾‹ï¼Œå¹¶ä½¿ç”¨å®ƒå»å‘èµ·è¯·æ±‚ã€‚ ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢æ‰æ—§çš„æµ‹è¯•ï¼š

[source,kotlin]
-----
@ExperimentalTime
@ExperimentalCoroutinesApi
@Test
fun `test that messages API streams latest messages`() {
   runBlocking {
       val rSocketRequester =
            rsocketBuilder.websocket(URI("ws://localhost:${serverPort}/rsocket"))

       rSocketRequester
           .route("api.v1.messages.stream")
           .retrieveFlow<MessageVM>()
           .test {
               assertThat(expectItem().prepareForTesting())
                   .isEqualTo(
                       MessageVM(
                           "*testMessage*",
                           UserVM("test", URL("http://test.com")),
                           now.minusSeconds(2).truncatedTo(MILLIS)
                       )
                   )

               assertThat(expectItem().prepareForTesting())
                   .isEqualTo(
                       MessageVM(
                           "<body><p><strong>testMessage2</strong></p></body>",
                           UserVM("test1", URL("http://test.com")),
                           now.minusSeconds(1).truncatedTo(MILLIS)
                       )
                   )
               assertThat(expectItem().prepareForTesting())
                   .isEqualTo(
                       MessageVM(
                           "<body><p><code>testMessage3</code></p></body>",
                           UserVM("test2", URL("http://test.com")),
                           now.truncatedTo(MILLIS)
                       )
                   )

               expectNoEvents()

               launch {
                   rSocketRequester.route("api.v1.messages.stream")
                       .dataWithType(flow {
                           emit(
                               MessageVM(
                                   "`HelloWorld`",
                                   UserVM("test", URL("http://test.com")),
                                   now.plusSeconds(1)
                               )
                           )
                       })
                       .retrieveFlow<Void>()
                       .collect()
               }

               assertThat(expectItem().prepareForTesting())
                   .isEqualTo(
                       MessageVM(
                           "<body><p><code>HelloWorld</code></p></body>",
                           UserVM("test", URL("http://test.com")),
                           now.plusSeconds(1).truncatedTo(MILLIS)
                       )
                   )

               cancelAndIgnoreRemainingEvents()
           }
   }
}

@ExperimentalTime
@Test
fun `test that messages streamed to the API is stored`() {
   runBlocking {
       launch {
           val rSocketRequester =
                rsocketBuilder.websocket(URI("ws://localhost:${serverPort}/rsocket"))

           rSocketRequester.route("api.v1.messages.stream")
               .dataWithType(flow {
                   emit(
                       MessageVM(
                           "`HelloWorld`",
                           UserVM("test", URL("http://test.com")),
                           now.plusSeconds(1)
                       )
                   )
               })
               .retrieveFlow<Void>()
               .collect()
       }

       delay(2.seconds)

       messageRepository.findAll()
           .first { it.content.contains("HelloWorld") }
           .apply {
               assertThat(this.prepareForTesting())
                   .isEqualTo(
                       Message(
                           "`HelloWorld`",
                           ContentType.MARKDOWN,
                           now.plusSeconds(1).truncatedTo(MILLIS),
                           "test",
                           "http://test.com"
                       )
                   )
           }
   }
}
-----

== Summary æ€»ç»“

è¿™æ˜¯æˆ‘ä»¬æ•™ç¨‹çš„æœ€åä¸€ä¸ªéƒ¨åˆ†ã€‚ æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„èŠå¤©åº”ç”¨å¼€å§‹ï¼Œé‚£ä¸ªå½“ç•Œé¢æŸ¥è¯¢æ–°æ¶ˆæ¯æ—¶åç«¯æ˜¯é˜»å¡åœ°æŸ¥è¯¢æ•°æ®åº“çš„ã€‚ æˆ‘ä»¬é€æ­¥æ·»åŠ ç‰¹æ€§åˆ°è¿™ä¸ªåº”ç”¨å¹¶è¿ç§»åˆ°å“åº”å¼SpringæŠ€æœ¯æ ˆã€‚åç«¯ç°åœ¨å·²ç»å®Œå…¨å¼‚æ­¥ï¼Œ
åˆ©ç”¨äº† Spring WebFlux å’Œ Kotlin åç¨‹ã€‚
